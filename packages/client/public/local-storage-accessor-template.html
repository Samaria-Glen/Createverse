
<html lang="en">
<head id="head">
    <title>Local Storage Accessor</title>
    <script>
        window.onload = async() => {
            console.log('local-storage-accessor is loaded')
            const allowedDomains = "<ALLOWED_DOMAINS>"
            window.onmessage = async function(e) {
                console.log('GOT MESSAGE', e)
                if (allowedDomains.indexOf(e.origin) < 0) return;
                const payload = JSON.parse(e.data);
                console.log('payload', payload)
                const parent = window.parent;
                switch (payload.method) {
                    case 'set':
                        localStorage.setItem(payload.key, JSON.stringify(payload.data));
                        document.cookie = `${payload.key}=${JSON.stringify(payload.data)}; SameSite=None; Secure`
                        break;
                    case 'get':
                        const data = document.cookie
                            .split("; ")
                            .find((row) => row.startsWith(`${payload.key}=`))
                            ?.split("=")[1];
                        console.log('got cookie', data)
                        parent.postMessage(data, e.origin);
                        break;
                    case 'remove':
                        localStorage.removeItem(payload.key);
                        break;
                    case 'checkAccess':
                        if (!document.hasStorageAccess) {
                            parent.postMessage('true', e.origin)
                            break
                        }
                        else {
                            const hasAccess = await document.hasStorageAccess()
                            console.log('hasAccess', hasAccess)
                            parent.postMessage(hasAccess.toString(), e.origin)
                            break
                        }
                }
            }

            // if (!document.hasStorageAccess) createOnmessage()
            // else {
            //     const hasAccess = await document.hasStorageAccess()
            //     console.log('hasAccess', hasAccess)
            //     if (hasAccess) createOnmessage()
            //     else {
            //         try {
            //             const permission = await navigator.permissions.query({
            //                 name: 'storage-access'
            //             })
            //
            //             console.log('permission', permission, permission.state)
            //
            //             if (permission.state === 'granted') {
            //                 console.log('permission.state is granted')
            //                 await document.requestStorageAccess()
            //                 createOnmessage()
            //             } else if (permission.state === 'prompt') {
            //                 console.log('permission.state is prompt')
            //                 // document.getElementById('allow-push-notification-bar').show();
            //                 window.open('https://local.etherealengine.org/main-site-cookie-acknowledgement.html', '_top', 'popup=true')
            //                 document.addEventListener('click', async function () {
            //                     console.log('GOT CLICK')
            //                     // document.getElementById('allow-push-notification-bar').hide();
            //                     try {
            //                         await document.requestStorageAccess();
            //                         createOnmessage();
            //                     } catch (err) {
            //                         // If there is an error obtaining storage access.
            //                         console.error(`Error obtaining storage access: ${err}.
            //                     Please sign in.`);
            //                     }
            //                 })
            //                 // window.onclick = async() => {
            //                 //     console.log('IFRAME CLICKED')
            //                 //     try {
            //                 //         await document.requestStorageAccess();
            //                 //         createOnmessage();
            //                 //     } catch (err) {
            //                 //         // If there is an error obtaining storage access.
            //                 //         console.error(`Error obtaining storage access: ${err}.
            //                 //     Please sign in.`);
            //                 //     }
            //                 // }
            //             } else if (permission.state === 'denied') {
            //                 console.log('permission.state is denied')
            //                 createOnmessage()
            //             } else {
            //                 console.log('permission.state is something else', permission.state)
            //             }
            //         } catch(err) {
            //             console.log('Could not access permission state', err)
            //             createOnmessage()
            //         }
            //     }
            // }
        }

        // window.onload = async () => {
        //     console.log('local-storage-accessor running')
        //     // Check for iOS / Safari.
        //     if (!!document.hasStorageAccess) {
        //         try {
        //             const access = await document.hasStorageAccess()
        //
        //             console.log('hasStorageAccess', access)
        //             // If we don't have access we must request it, but the request
        //             // must come from a UI event.
        //             if (!access) {
        //                 console.log('window.location.href', window.location.href)
        //                 window.top.location = "https://local.etherealengine.org/main-site-cookie-acknowledgement.html";
        //                 // // Show the button and tie to the click.
        //                 // const requestStorageAccessButton =
        //                 //     document.getElementById('requestStorageAccessButton');
        //                 // requestStorageAccessButton.style.display = "block";
        //                 // requestStorageAccessButton.addEventListener("click", event => {
        //                 //     console.log('CLICKED BUTTON')
        //                 //
        //                 //     // On UI event, consume the event by requesting access.
        //                 //     document.requestStorageAccess().then(result => {
        //                 //
        //                 //         // Finally, we are allowed! Reload to get the cookie.
        //                 //         window.location.reload();
        //                 //     }).catch(err => {
        //                 //
        //                 //         // If we get here, it means either our page
        //                 //         // was never loaded as a first party page,
        //                 //         // or the user clicked 'Don't Allow'.
        //                 //         // Either way open that now so the user can request
        //                 //         // from there (or learn more about us).
        //                 //         window.top.location = window.location.href +
        //                 //             "main-site-cookie-acknowledgement.html";
        //                 //     });
        //                 // });
        //             }
        //         } catch (err) {
        //             console.error(err)
        //         }
        //     }
        // }
    </script>
</head>
<body>
</body>
</html>
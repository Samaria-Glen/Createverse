
<html lang="en">
<head id="head">
    <title>Local Storage Accessor</title>
    <script>
        let allowedDomains = "<ROOT_DOMAIN>"
        window.onload = async() => {
            console.log('root-cookie-accessor is loaded')
            try {
                const response = await fetch("<ALLOWED_DOMAIN_LINK>")
                console.log('allowed domain response', response)
                const body = await response.json()
                console.log('body', body)
                if (Array.isArray(body)) allowedDomains = allowedDomains.concat(body)
            } catch(err) {
                //Don't do anything if the file is missing; only requests from the root domain will be permitted
            }
            console.log('allowedDomains', allowedDomains)

        }
        window.onmessage = async function(e) {
            console.log('GOT MESSAGE', e)
            if (allowedDomains.indexOf(e.origin) < 0) return;
            const payload = e?.data ? JSON.parse(e.data) : null;
            console.log('payload', payload)
            const parent = window.parent;
            switch (payload.method) {
                case 'set':
                    if (payload?.data) {
                        localStorage.setItem(payload.key, JSON.stringify(payload.data));
                        document.cookie = `${payload.key}=${JSON.stringify(payload.data)}; SameSite=None; Secure`
                    }
                    break;
                case 'get':
                    console.log('Getting cookie', document.cookie)
                    const data = document.cookie
                        .split("; ")
                        .find((row) => row.startsWith(`${payload.key}=`))
                        ?.split("=")[1];
                    console.log('got cookie', data)
                    parent.postMessage(data || '', e.origin);
                    break;
                case 'remove':
                    document.cookie = document.cookie
                        .split("; ")
                        .find((row) => row.startsWith(`${payload.key}=`))
                        .replace(/^ +/, "")
                        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    break;
                case 'checkAccess':
                    if (!document.hasStorageAccess) {
                        console.log('hasStorageAccess does not exist')
                        parent.postMessage('true', e.origin)
                        break
                    }
                    else {
                        const hasAccess = await document.hasStorageAccess()
                        console.log('hasAccess', hasAccess)
                        parent.postMessage(hasAccess.toString(), e.origin)
                        break
                    }
            }
        }
        console.log('created onmessage listener')
    </script>
</head>
<body>
</body>
</html>